<script type="text/javascript">
  RED.nodes.registerType("measurement", {
    category: "quantum",
    color: "#33B1FF",
    defaults: {
      name: { value: "" },
      selectedCbit: { value: "" },
      selectedCreg: { value: "" },
    },
    inputs: 1,
    outputs: 1,
    icon: "function.svg",
    paletteLabel: "measurement",
    label: function () {
      return this.name || "measurement";
    },
    oneditprepare: function () {
      $.getJSON('quantum-circuit/structure', function (data) {
          let structure = data.structure;
          if (structure === 'registers') {
            const parentDiv = $("#reg-form");
            $.getJSON("quantum-circuit/registers", function (data) {
              let registers = data.classicalRegisters;
              let regCnt = 0;
              registers.forEach((register) => {
                let inputId = 'node-input-classreg' + regCnt;
                let myNewRow = $('<div class="form-row" />');
                parentDiv.append(myNewRow);

                const options = []
                for (let i = 0; i < Number(register.bits); i++) {
                  options.push(i);
                }
                let registerHeading = $(`<span>Classical register: ${register.regName.replace(/_/g, ' ')}</span><br/>`);
                myNewRow.append(registerHeading);
                options.forEach((bit) => {
                  let subInputId = inputId + 'b' + bit;
                  let myNewLabel = $(`<label for="${inputId}"><i class="fa fa-globe"></i> Bit #: ${bit}</label>`);
                  let myNewInput = $(`<input type="checkbox" class="classreg-element" id="${subInputId}" reg-nodeid="${register.nodeid}" reg-varname-="${register.regVarName}" />`);
                  myNewRow.append(myNewLabel);
                  myNewRow.append(myNewInput);
                });
                regCnt += 1;
              });
            });
          }
      });
    },
    oneditsave: function () {
      var selectBitIndex = document.getElementById("node-input-cbitindex");
      var selectRegIndex = document.getElementById("node-input-cregindex");
      this.selectedCbit = selectBitIndex.value;
      this.selectedCreg = selectRegIndex.value;
    },
  });
</script>

<script type="text/html" data-template-name="measurement">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Measurement Node</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>
  <div id="reg-form">
  </div>
</script>

<script type="text/html" data-help-name="measurement">
  <p>
    Quantum measurement node
  </p>
</script>
