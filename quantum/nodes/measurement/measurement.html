<script type="text/javascript">
  RED.nodes.registerType("measurement", {
    category: "quantum",
    color: "#33b1ff",
    defaults: {
      name: { value: "" },
      selectedBit: { value: "" },
      selectedRegVarName: { value: "" },
      selectedRadio: {value: ""},
    },
    inputs: 1,
    outputs: 1,
    icon: "function.svg",
    paletteLabel: "measurement",
    label: function () {
      return this.name || "measurement";
    },
    oneditprepare: function () {
      var selectedRadio = this.selectedRadio;
      $.getJSON('quantum-circuit/structure', function (data) {
        let structure = data.structure;
        const parentDiv = $("#reg-form");
        if (structure === 'registers') {
          $.getJSON("quantum-circuit/registers", function (data) {
            let registers = data.classicalRegisters;
            registers.forEach((register) => {
              let inputId = 'node-input-classreg-' + register.regName;
              let myNewRow = $('<div class="form-row" />');
              parentDiv.append(myNewRow);

              const bitArray = []
              for (let i = 0; i < Number(register.bits); i++) {
                bitArray.push(i);
              }

              let registerHeading = $(`<span>Classical register: ${register.regName.replace(/_/g, ' ')}</span><br/>`);
              myNewRow.append(registerHeading);
              bitArray.forEach((bit) => {
                let subInputId = inputId + '-b' + bit;
                let myNewLabel = $(`<label for="${subInputId}"><i class="fa fa-circle"></i> Bit ${bit}</label>`);
                let myNewInput = $(`<input type="radio" name="bit" class="classreg-element" id="${subInputId}" value="${subInputId}" data-varname="${register.regVarName}" data-bit="${bit}"/>`);
                myNewRow.append(myNewLabel);
                myNewRow.append(myNewInput);
                if (subInputId === selectedRadio) {
                  $("#" + subInputId).prop("checked", true)
                }
              });
            });
          });
        }
        else {
          $.getJSON("quantum-circuit/bits", function (data) {
            let myNewRow = $('<div class="form-row" />');
            parentDiv.append(myNewRow);
            const bitArray = []
            for (let i = 0; i < Number(data.bits); i++) {
              bitArray.push(i);
            }

            bitArray.forEach((bit) => {
              let InputId = 'node-input-cbit-' + bit;
              let myNewLabel = $(`<label for="${InputId}"><i class="fa fa-circle"></i> Bit ${bit}</label>`);
              let myNewInput = $(`<input type="radio" name="bit" class="classreg-element" id="${InputId}" value="${InputId}" data-bit="${bit}"/>`);
              myNewRow.append(myNewLabel);
              myNewRow.append(myNewInput);
              if (InputId === selectedRadio) {
                $("#" + InputId).prop("checked", true)
              }
            });
          });
        }
      });
    },
    oneditsave: function () {
      var classregElements = $(".classreg-element");
      var selectedRadio, selectedRegVarName, selectedBit;

      classregElements.each( function(index,el) {
        var checked = $(el).is(":checked");
        if (checked === true) {
          selectedRadio = el.id;
          selectedRegVarName = $(el).data('varname');
          selectedBit = $(el).data('bit');
        }
      });
      this.selectedRadio = selectedRadio;
      this.selectedRegVarName = selectedRegVarName;
      this.selectedBit = selectedBit;
    },
  });
</script>

<script type="text/html" data-template-name="measurement">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Measurement Node</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>
  <div id="reg-form">
  </div>
</script>

<script type="text/html" data-help-name="measurement">
  <p>
    Quantum measurement node
  </p>
</script>
